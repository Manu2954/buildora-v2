generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Roles for RBAC
enum Role {
  ADMIN
  SALESMAN
  CUSTOMER
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      Role     @default(CUSTOMER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  refreshTokens RefreshToken[]
  // Back-relations
  assignedLeads Lead[]      @relation("LeadAssignedToUser")
  leadNotes     LeadNote[]  @relation("LeadNoteAuthor")
  leadEvents    LeadEvent[] @relation("LeadEventActor")
}

model RefreshToken {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  token     String   @unique
  revoked   Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// Existing CTA models
model Lead {
  id          String   @id @default(cuid())
  name        String?
  email       String?
  phone       String?
  message     String?
  location    String?
  requirement String?
  page        String?
  variant     String?
  source      String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?
  fingerprint String?
  ip          String?
  userAgent   String?
  status      LeadStatus @default(NEW)
  priority    LeadPriority @default(MEDIUM)
  followUpAt  DateTime?
  assignedTo  User?      @relation("LeadAssignedToUser", fields: [assignedToId], references: [id])
  assignedToId String?
  createdAt   DateTime @default(now())
  notes       LeadNote[]
  events      LeadEvent[]
}

model CtaConfig {
  key       String   @id // e.g., "cta:homepage"
  json      Json
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

enum LeadStatus {
  NEW
  CONTACTED
  CLOSED
}

enum LeadPriority {
  LOW
  MEDIUM
  HIGH
}

model LeadNote {
  id        String   @id @default(cuid())
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId    String
  author    User?    @relation("LeadNoteAuthor", fields: [authorId], references: [id])
  authorId  String?
  content   String
  createdAt DateTime @default(now())
}

model LeadEvent {
  id        String   @id @default(cuid())
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId    String
  actor     User?    @relation("LeadEventActor", fields: [actorId], references: [id])
  actorId   String?
  type      String
  data      Json?
  createdAt DateTime @default(now())
}
